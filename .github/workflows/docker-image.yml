name: Build and Push Docker Image with Tag
on: 
    push: 
        branches: [main]


jobs:
    build:
        runs-on: self-hosted
        steps:
        - name: checkout repo
          uses: actions/checkout@v3
          
        - name: set Image_tag
          run:  echo "IMAGE_TAG=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

        - name: login to dockerhub
          run:  echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
         
        - name:  build docker image
          run: docker build -t abhishekkk15/swiggy_clone:${{env.IMAGE_TAG}}
        
        - name: push image to docker hub
          run: docker push abhishekkk15/swiggy_clone:${{env.IMAGE_TAG}}

        - name: update deployment yml with new tag
          run: |
                sed -i "s|image: yourusername/vite-app:.*|image: yourusername/vite-app:${{ env.IMAGE_TAG }}|" k8s/deployment.yaml

        - name: Commit and push updated YAML
          run: |
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git commit -am "Update image tag to ${{ env.IMAGE_TAG }}"
            git push